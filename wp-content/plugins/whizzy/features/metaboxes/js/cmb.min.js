(function(e,i,t,r){"use strict";e.CMB={formfield:"",iterator:0,file_frames:{},init:function(){CMB.log(e.whizzy_l10),e.whizzy_l10.new_admin_style&&t(".cmb-spinner img").hide(),t(".whizzy_timepicker").each(function(){t("#"+jQuery(this).attr("id")).timePicker({startTime:"07:00",endTime:"22:00",show24Hours:!1,separator:":",step:30})}),t(".whizzy_datepicker").each(function(){t("#"+jQuery(this).attr("id")).datepicker()}),t("#ui-datepicker-div").wrap('<div class="whizzy_element" />'),"object"==typeof jQuery.wp&&"function"==typeof jQuery.wp.wpColorPicker?t("input:text.whizzy_colorpicker").wpColorPicker():t("input:text.whizzy_colorpicker").each(function(e){t(this).after('<div id="picker-'+e+'" style="z-index: 1000; background: #EEE; border: 1px solid #CCC; position: absolute; display: block;"></div>'),t("#picker-"+e).hide().farbtastic(t(this))}).focus(function(){t(this).next().show()}).blur(function(){t(this).next().hide()}),t(".whizzy_id__whizzy_file").on("change",".whizzy_upload_file",function(){CMB.formfield=t(this).attr("name"),t("#"+CMB.formfield+"_id").val("")}).on("click",".whizzy_upload_button",function(i){i.preventDefault();var r=t(this);CMB.formfield=r.prev("input").attr("name");var l=t("#"+CMB.formfield),o=!0,a=!0,n=r.hasClass("whizzy_upload_list");return CMB.formfield in CMB.file_frames?void CMB.file_frames[CMB.formfield].open():(CMB.file_frames[CMB.formfield]=wp.media.frames.file_frame=wp.media({title:t("label[for="+CMB.formfield+"]").text(),button:{text:e.whizzy_l10.upload_file},multiple:!!n}),CMB.file_frames[CMB.formfield].on("select",function(){if(n){a=CMB.file_frames[CMB.formfield].state().get("selection").toJSON(),l.val(a.url),t("#"+CMB.formfield+"_id").val(a.id);var e=[];t(a).each(function(){o=this.type&&"image"===this.type?'<li class="img_status"><img width="50" height="50" src="'+this.url+'" class="attachment-50x50" alt="'+this.filename+'"><p><a href="#" class="whizzy_remove_file_button" rel="'+CMB.formfield+"["+this.id+']">'+whizzy_l10.remove_image+'</a></p><input type="hidden" id="filelist-'+this.id+'" name="'+CMB.formfield+"["+this.id+']" value="'+this.url+'"></li>':"<li>"+whizzy_l10.file+" <strong>"+this.filename+'</strong>&nbsp;&nbsp;&nbsp; (<a href="'+this.url+'" target="_blank" rel="external">'+whizzy_l10.download+'</a> / <a href="#" class="whizzy_remove_file_button" rel="'+CMB.formfield+"["+this.id+']">'+whizzy_l10.remove_file+'</a>)<input type="hidden" id="filelist-'+this.id+'" name="'+CMB.formfield+"["+this.id+']" value="'+this.url+'"></li>',e.push(o)}),t(e).each(function(){l.siblings(".whizzy_media_status").slideDown().append(this)})}else a=CMB.file_frames[CMB.formfield].state().get("selection").first().toJSON(),l.val(a.url),t("#"+CMB.formfield+"_id").val(a.id),o=a.type&&"image"===a.type?'<div class="img_status"><img style="max-width: 350px; width: 100%; height: auto;" src="'+a.url+'" alt="'+a.filename+'" title="'+a.filename+'" /><p><a href="#" class="whizzy_remove_file_button" rel="'+CMB.formfield+'">'+whizzy_l10.remove_image+"</a></p></div>":whizzy_l10.file+" <strong>"+a.filename+'</strong>&nbsp;&nbsp;&nbsp; (<a href="'+a.url+'" target="_blank" rel="external">'+whizzy_l10.download+'</a> / <a href="#" class="whizzy_remove_file_button" rel="'+CMB.formfield+'">'+whizzy_l10.remove_file+"</a>)",l.siblings(".whizzy_media_status").slideDown().html(o)}),void CMB.file_frames[CMB.formfield].open())}).on("click",".whizzy_remove_file_button",function(e){e.preventDefault();var i=t(this);if(i.is(".attach_list .whizzy_remove_file_button"))return i.parents("li").remove(),!1;CMB.formfield=i.attr("rel");var r=i.parents(".img_status");return t("input#"+CMB.formfield).val(""),t("input#"+CMB.formfield+"_id").val(""),r.length?r.html(""):i.parents(".whizzy_media_status").html(""),!1}).on("click",".add-row-button",function(e){e.preventDefault();var i=t(this),r="#"+i.data("selector"),l=t(r),o=t(".empty-row",l).clone(!0);o.removeClass("empty-row").addClass("repeat-row"),o.insertBefore(r+" tbody>tr:last");var a=t("input.whizzy_datepicker",o),n=a.attr("id");a.attr("id",n+CMB.iterator),CMB.iterator++}).on("click",".remove-row-button",function(e){e.preventDefault();var i=t(this),r=i.parents(".cmb-repeat-table");CMB.log("number of tbodys",r.length),CMB.log("number of trs",t("tr",r).length),t("tr",r).length>2&&i.parents(".cmb-repeat-table tr").remove()}).on("keyup",".whizzy_oembed",function(e){CMB.doAjax(t(this),e)}),t(".whizzy_oembed").bind("paste",function(e){var i=t(this);setTimeout(function(){CMB.doAjax(i,"paste")},100)}).blur(function(){setTimeout(function(){CMB.spinner(".postbox table.whizzy_metabox",!0)},2e3)}),setTimeout(CMB.resizeoEmbeds,500),t(e).on("resize",CMB.resizeoEmbeds)},log:function(){e.whizzy_l10.script_debug&&console&&"function"==typeof console.log&&console.log.apply(console,arguments)},spinner:function(e,i){i?t(".cmb-spinner",e).hide():t(".cmb-spinner",e).show()},doAjax:function(i,r){var l=i.val();if(!(l.length<6)&&("paste"===r||r.which<=90&&r.which>=48||r.which>=96&&r.which<=111||8==r.which||9==r.which||187==r.which||190==r.which)){var o=i.attr("id"),a=i.parents(".whizzy_metabox tr td"),n=t(".embed_status",a),s=i.width(),h=t(":first-child",n);s=n.length&&h.length?h.width():i.width(),CMB.spinner(a),t(".embed_wrap",a).html(""),setTimeout(function(){t(".whizzy_oembed:focus").val()==l&&t.ajax({type:"post",dataType:"json",url:e.whizzy_l10.ajaxurl,data:{action:"whizzy_oembed_handler",oembed_url:l,oembed_width:s>300?s:300,field_id:o,object_id:i.data("objectid"),object_type:i.data("objecttype"),whizzy_ajax_nonce:e.whizzy_l10.ajax_nonce},success:function(e){CMB.log(e),"undefined"!=typeof e.id&&(CMB.spinner(a,!0),t(".embed_wrap",a).html(e.result))}})},500)}},resizeoEmbeds:function(){t("table.whizzy_metabox").each(function(e){var i=t(this),r=i.parents(".inside");if(!r.length)return!0;var l=r.width(),o=Math.round(.82*l*.97)-30;if(o>639)return!0;var a=t(".cmb-type-oembed .embed_status",i).children().first(),n=a.width(),s=a.height(),h=Math.round(o*s/n);a.width(o).height(h)})}},t(i).ready(CMB.init)})(window,document,jQuery);